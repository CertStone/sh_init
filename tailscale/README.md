### **自动化 Tailscale + DERP 节点部署脚本 - 使用文档**



#### **1. 简介**



本文档适用于 `setup_derp_node*.sh` 系列脚本。

该脚本旨在自动化地在一个全新的公网服务器上，部署一个私有的 Tailscale DERP 中继节点。

脚本通过一系列交互式提问引导用户完成个性化配置。



#### **2. 功能概览**



- **环境自动准备**: 自动安装 Docker, Docker-Compose, Tailscale, acme.sh, openssl 等所有必需依赖。
- **系统兼容适配**: 自动检测服务器的操作系统（Debian/Ubuntu）及其版本代号，并配置正确的 Tailscale 软件源。
- **网络源优化**:
  - 自动将 Tailscale 的 `apt` 源替换为速度更快的**中科大镜像源**。
  - 提供**可选的 Docker 镜像源配置**功能，加速 Docker 镜像拉取。
- **灵活的证书方案**:
  - 支持使用 **Let's Encrypt** 签发的公网信任证书。
  - 支持在无法申请公网证书时，生成**符合现代安全标准 (SANs) 的自签名证书**，避免客户端报错。
- **配置高度自定义**:
  - 允许用户自定义 DERP 服务的端口。
  - 允许用户选择要使用的 `derper` Docker 镜像。
- **智能化配置生成**:
  - 自动生成 `docker-compose.yml` 配置文件。
  - 在脚本执行结束时，根据用户选择的证书类型，**智能生成对应的 `derpMap` JSON 代码块**，供用户直接复制到 Tailscale 管理后台。
- **安全可靠**:
  - 默认开启 DERP 客户端验证 (`DERP_VERIFY_CLIENTS=true`)，防止被陌生人“蹭用”节点。
  - 脚本本身遵循 Shell 编程最佳实践，格式规范，逻辑清晰。



#### **3. 使用要求**



在运行脚本前，请确保您已具备：

- 一台拥有公网 IP 的服务器 (VPS, 云主机等)，确保 `tcp/udp` 均可访问。
- 支持的操作系统：Debian 11+ 或 Ubuntu 20.04+。
- 服务器的 `root` 或 `sudo` 管理权限。
- 一个**域名**，并已将其 DNS 解析指向您的服务器公网 IP (如果计划使用 Let's Encrypt 证书)。
- 一个 Tailscale 账号。



#### **4. 使用步骤**



1. 下载脚本:

   ```bash
   wget -O setup_derp_node.sh https://gitee.com/wo99/sh_init/raw/main/tailscale/setup_derp_node_v8.sh
   ```

2. **授予执行权限**:

   ```bash
   chmod +x setup_derp_node.sh
   ```

3. **以 root 身份运行**:

   ```bash
   sudo ./setup_derp_node.sh
   ```

4. 根据提示进行交互:

   脚本将会依次询问您几个问题，请根据您的实际情况回答：

   - **是否配置 Docker 镜像源**: 建议输入 `Y` 或直接回车，以加速后续过程。
   - **Tailscale 认证**: 脚本会暂停并显示一个 URL，请在浏览器中打开此链接，登录并授权您的服务器。完成后回到终端按回车继续。
   - **输入 DERP 域名**: 输入您准备好的域名，例如 `derp.yourdomain.com`。
   - **选择证书类型**:
     - 如果您的域名已正确解析，且服务器 80 端口可被公网访问，请输入 `L` 或直接回车，使用 Let's Encrypt。
     - 否则，请输入 `S` 使用自签名证书。

5. 完成最后的 ACL 配置:

   脚本执行完毕后，会打印出一段 JSON 代码。请完整复制这段代码，登录 Tailscale Admin Console，找到 `derpMap` 部分，将代码粘贴到 `"Regions": { ... } `的大括号内部，并保存。

   **注意**：如果已有其他节点，请确保新节点的 `RegionID` 是唯一的（例如，将 `911` 修改为 `912`）。



#### **5. 验证与排错**



- **验证 DERP 是否工作**: 在您**其他**的 Tailscale 设备上运行 `tailscale netcheck`，如果在列表中能看到您自定义的节点名称和延迟，即表示成功。
- **查看 DERP 日志**: 在服务器上运行 `docker logs derper` 可以查看实时日志，用于排查问题。
- **常见问题**:
  - **Let's Encrypt 申请失败**: 请检查您的域名是否已生效，以及云服务商的**安全组**是否已放行服务器的 `TCP 80/443` 端口。
  - **`netcheck` 看不到节点**: 请检查云服务商的**安全组**是否已放行您自定义的 DERP 端口（默认为 `TCP 60011`）和 STUN 端口（`UDP 3478`）。

------



### **附录：v8 和 v12 脚本版本区别详解**



在我们的调试过程中，脚本经历了多次迭代。其中，v8 和 v12 是两个具有代表性的节点，它们之间存在两个核心区别：



| 对比维度        | 脚本 v8                                    | 脚本 v12                       | 区别与原因                                                   |
| --------------- | ------------------------------------------ | ------------------------------ | ------------------------------------------------------------ |
| **核心功能**    | 已具备所有核心功能（自定义、证书选择等）。 | **完全保留** v8 的所有功能。   | 功能上没有减少。                                             |
| **docker镜像**  | `fredliang/derper:latest`                  | `javaow/tailscale-derp:latest` | 这是最重要的区别。v12容器对直接使用ip连接的情况进行了优化，去除了证书验证，不过可能更新不及时。v8使用的是正常的derper容器。 |
| **HTTPS端口号** | 默认60011，可以修改                        | 36666，不能修改                | 换用镜像导致的。                                             |

**总结：**

v8 与 v12 并没有优劣之分，对于一般的机器推荐先尝试v8，想拿ip直连请使用v12，域名随便填一下就行，在acl里改掉即可。